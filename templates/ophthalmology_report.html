{% load static %}
<!DOCTYPE html><html><head>
  <meta charset="utf-8">
  <style>
    @page :first {
      size: A4 portrait;
      margin:5cm 1cm 1cm 1cm;
      @top-center { content: element(firstHeader) }
      @bottom-center { content: "Page " counter(page) " of " counter(pages) }
    }
    @page {
      size: A4 portrait;
      margin:3cm 1cm 1cm 1cm;
      @top-center { content: element(normalHeader) }
      @bottom-center { content: "Page " counter(page) " of " counter(pages) }
    }
    header#firstHeader  { position: running(firstHeader) }
    header#normalHeader { position: running(normalHeader) }
    body { font-family: sans-serif; font-size:12px }
    header img { max-height:40px; float:left; margin-right:10px }
    header h2 { text-align:center; line-height:40px; margin:0; font-size:16px }
    header .date { text-align:center; font-size:10px }
    header hr    { border:none; border-bottom:1px solid #333; margin:5px 0 }
    .district-line { text-align:center; font-size:10px; margin:4px 0 8px }
    table { width:100%; border-collapse:collapse; margin-bottom:1em; font-size:11px; table-layout: fixed; word-wrap: break-word }
    th,td { border:1px solid #ccc; padding:6px; text-align:left; word-wrap: break-word; white-space: normal }
    table th:first-child,
    table td:first-child {
      width: 30px;
      max-width: 30px;
      text-align: center;
    }
    td.age-true      { background: #FFEB3B; }  /* yellow */
    td.ot-true       { background: #E91E63; }  /* magenta */
    td.preauth-true  { background: #009688; }  /* teal */
    thead { background:rgb(82,90,130); color:#fff }
    tbody tr:nth-child(even){ background:#fafafa }
    .chart-section { page-break-before: always; margin-top:1em }
    .chart-section img { display:block; margin:0 auto .5em; max-width:100% }
    .callouts { font-size:10px; margin:0 auto 1em; width:80% }
  </style>
</head><body>

  <!-- First page header -->
  <header id="firstHeader">
    <img src="{{ logo_url }}" alt="Logo"/>
    <h2>{{ title }}</h2>
    <div class="date">Generated on {{ date }}</div>
    <hr/>
    <div class="district-line">
      District: {% if report_districts %}{{ report_districts|join:", " }}{% else %}All{% endif %}
    </div>
  </header>

  <!-- Subsequent pages header -->
  <header id="normalHeader">
    <img src="{{ logo_url }}" alt="Logo"/>
    <h2>{{ title }}</h2>
    <hr/>
  </header>

  <main>
    {# — for each section, only include if needed — #}
    {% if violation_type == 'all' %}
      <section>
        <h3>All Cataract Violations</h3>
        <table>
          <thead><tr>
            <th>#</th>
            <th>Claim ID</th>
            <th>Patient</th>
            <th>District</th>
            <th>Hospital ID</th>
            <th>Hospital Name</th>
            <th>Amount (₹)</th>
            <th>Age < 40</th>
            <th>OT Cases</th>
            <th>Preauth Time</th>
          </tr></thead>
          <tbody>
            {% for r in all_rows %}
            <tr>
              <td>{{ r.serial_no }}</td>
              <td>{{ r.claim_id }}</td>
              <td>{{ r.patient_name }}</td>
              <td>{{ r.district }}</td>
              <td>{{ r.hospital_id }}</td>
              <td>{{ r.hospital_name }}</td>
              <td>{{ r.amount }}</td>
              <td class="{% if r.age_lt_40 %}age-true{% endif %}">
                {{ r.age_lt_40|yesno:"True,False" }}
              </td>
              <td class="{% if r.ot_cases %}ot-true{% endif %}">
                {{ r.ot_cases|yesno:"True,False" }}
              </td>
              <td class="{% if r.preauth_time %}preauth-true{% endif %}">
                {{ r.preauth_time|yesno:"True,False" }}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </section>
      <section class="chart-section">
        <h3>Combined Distribution</h3>
        <img src="data:image/png;base64,{{ combined_chart_b64 }}" alt=""/>
      </section>
      <section class="chart-section">
        <h4>Age Distribution (All)</h4>
        <img src="data:image/png;base64,{{ all_age_b64 }}" alt=""/>
        <div class="callouts">{{ all_age_callouts|safe }}</div>
        <h4>Gender Distribution (All)</h4>
        <img src="data:image/png;base64,{{ all_gender_b64 }}" alt=""/>
        <div class="callouts">{{ all_gender_callouts|safe }}</div>
        {% if map_all_b64 %}
          <img src="data:image/png;base64,{{ map_all_b64 }}" alt="Map View">
        {% endif %}
      </section>
    {% endif %}

    {% if violation_type == 'all' or violation_type == 'age' %}
      <section>
        <h3>Age &lt;40 Violations</h3>
        <table>
          <thead><tr>
            <th>#</th>
            <th>Claim ID</th>
            <th>Patient</th>
            <th>District</th>
            <th>Hospital ID</th>
            <th>Hospital Name</th>
            <th>Amount (₹)</th>
            <th>Age < 40</th>
            <th>OT Cases</th>
            <th>Preauth Time</th>
          </tr></thead>
          <tbody>
            {% for r in age_rows %}
            <tr>
              <td>{{ r.serial_no }}</td>
              <td>{{ r.claim_id }}</td>
              <td>{{ r.patient_name }}</td>
              <td>{{ r.district }}</td>
              <td>{{ r.hospital_id }}</td>
              <td>{{ r.hospital_name }}</td>
              <td>{{ r.amount }}</td>
              <td class="{% if r.age_lt_40 %}age-true{% endif %}">
                {{ r.age_lt_40|yesno:"True,False" }}
              </td>
              <td class="{% if r.ot_cases %}ot-true{% endif %}">
                {{ r.ot_cases|yesno:"True,False" }}
              </td>
              <td class="{% if r.preauth_time %}preauth-true{% endif %}">
                {{ r.preauth_time|yesno:"True,False" }}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </section>
      <section class="chart-section">
        <h3>Age &lt;40 Distribution</h3>
        <img src="data:image/png;base64,{{ age_chart_b64 }}" alt=""/>
      </section>
      <section class="chart-section">
        <h4>Age Distribution</h4>
        <img src="data:image/png;base64,{{ age_age_b64 }}" alt=""/>
        <div class="callouts">{{ age_age_callouts|safe }}</div>
        <h4>Gender Distribution</h4>
        <img src="data:image/png;base64,{{ age_gender_b64 }}" alt=""/>
        <div class="callouts">{{ age_gender_callouts|safe }}</div>
        {% if map_age_b64 %}
          <img src="data:image/png;base64,{{ map_age_b64 }}" alt="Map View">
        {% endif %}
      </section>
    {% endif %}

    {% if violation_type == 'all' or violation_type == 'ot' %}
      <section>
        <h3>OT Cases Violations</h3>
        <table>
          <thead><tr>
            <th>#</th>
            <th>Claim ID</th>
            <th>Patient</th>
            <th>District</th>
            <th>Hospital ID</th>
            <th>Hospital Name</th>
            <th>Amount (₹)</th>
            <th>Age < 40</th>
            <th>OT Cases</th>
            <th>Preauth Time</th>
          </tr></thead>
          <tbody>
            {% for r in ot_rows %}
            <tr>
              <td>{{ r.serial_no }}</td>
              <td>{{ r.claim_id }}</td>
              <td>{{ r.patient_name }}</td>
              <td>{{ r.district }}</td>
              <td>{{ r.hospital_id }}</td>
              <td>{{ r.hospital_name }}</td>
              <td>{{ r.amount }}</td>
              <td class="{% if r.age_lt_40 %}age-true{% endif %}">
                {{ r.age_lt_40|yesno:"True,False" }}
              </td>
              <td class="{% if r.ot_cases %}ot-true{% endif %}">
                {{ r.ot_cases|yesno:"True,False" }}
              </td>
              <td class="{% if r.preauth_time %}preauth-true{% endif %}">
                {{ r.preauth_time|yesno:"True,False" }}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </section>
      <section class="chart-section">
        <h3>OT Cases Distribution</h3>
        <img src="data:image/png;base64,{{ ot_chart_b64 }}" alt=""/>
      </section>
      <section class="chart-section">
        <h4>Age Distribution</h4>
        <img src="data:image/png;base64,{{ ot_age_b64 }}" alt=""/>
        <div class="callouts">{{ ot_age_callouts|safe }}</div>
        <h4>Gender Distribution</h4>
        <img src="data:image/png;base64,{{ ot_gender_b64 }}" alt=""/>
        <div class="callouts">{{ ot_gender_callouts|safe }}</div>
        {% if map_ot_b64 %}
          <img src="data:image/png;base64,{{ map_ot_b64 }}" alt="Map View">
        {% endif %}
      </section>
    {% endif %}

    {% if violation_type == 'all' or violation_type == 'preauth' %}
      <section>
        <h3>Pre-auth Time Violations</h3>
        <table>
          <thead><tr>
            <th>#</th>
            <th>Claim ID</th>
            <th>Patient</th>
            <th>District</th>
            <th>Hospital ID</th>
            <th>Hospital Name</th>
            <th>Amount (₹)</th>
            <th>Age < 40</th>
            <th>OT Cases</th>
            <th>Preauth Time</th>
          </tr></thead>
          <tbody>
            {% for r in multiple_rows %}
            <tr>
              <td>{{ r.serial_no }}</td>
              <td>{{ r.claim_id }}</td>
              <td>{{ r.patient_name }}</td>
              <td>{{ r.district }}</td>
              <td>{{ r.hospital_id }}</td>
              <td>{{ r.hospital_name }}</td>
              <td>{{ r.amount }}</td>
              <td class="{% if r.age_lt_40 %}age-true{% endif %}">
                {{ r.age_lt_40|yesno:"True,False" }}
              </td>
              <td class="{% if r.ot_cases %}ot-true{% endif %}">
                {{ r.ot_cases|yesno:"True,False" }}
              </td>
              <td class="{% if r.preauth_time %}preauth-true{% endif %}">
                {{ r.preauth_time|yesno:"True,False" }}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </section>
      <section class="chart-section">
        <h3>Pre-auth Time Distribution</h3>
        <img src="data:image/png;base64,{{ preauth_chart_b64 }}" alt=""/>
      </section>
      <section class="chart-section">
        <h4>Age Distribution</h4>
        <img src="data:image/png;base64,{{ preauth_age_b64 }}" alt=""/>
        <div class="callouts">{{ preauth_age_callouts|safe }}</div>
        <h4>Gender Distribution</h4>
        <img src="data:image/png;base64,{{ preauth_gender_b64 }}" alt=""/>
        <div class="callouts">{{ preauth_gender_callouts|safe }}</div>
        {% if map_preauth_b64 %}
          <img src="data:image/png;base64,{{ map_perauth_b64 }}" alt="Map View">
        {% endif %}
      </section>
    {% endif %}

    {% if violation_type == 'all' or violation_type == 'multiple' %}
      <section>
        <h3>More Than One Violations</h3>
        <table>
          <thead><tr>
            <th>#</th>
            <th>Claim ID</th>
            <th>Patient</th>
            <th>District</th>
            <th>Hospital ID</th>
            <th>Hospital Name</th>
            <th>Amount (₹)</th>
            <th>Age < 40</th>
            <th>OT Cases</th>
            <th>Preauth Time</th>
          </tr></thead>
          <tbody>
            {% for r in preauth_rows %}
            <tr>
              <td>{{ r.serial_no }}</td>
              <td>{{ r.claim_id }}</td>
              <td>{{ r.patient_name }}</td>
              <td>{{ r.district }}</td>
              <td>{{ r.hospital_id }}</td>
              <td>{{ r.hospital_name }}</td>
              <td>{{ r.amount }}</td>
              <td class="{% if r.age_lt_40 %}age-true{% endif %}">
                {{ r.age_lt_40|yesno:"True,False" }}
              </td>
              <td class="{% if r.ot_cases %}ot-true{% endif %}">
                {{ r.ot_cases|yesno:"True,False" }}
              </td>
              <td class="{% if r.preauth_time %}preauth-true{% endif %}">
                {{ r.preauth_time|yesno:"True,False" }}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </section>
      <section class="chart-section">
        <h3>Pre-auth Time Distribution</h3>
        <img src="data:image/png;base64,{{ preauth_chart_b64 }}" alt=""/>
      </section>
      <section class="chart-section">
        <h4>Age Distribution</h4>
        <img src="data:image/png;base64,{{ preauth_age_b64 }}" alt=""/>
        <div class="callouts">{{ preauth_age_callouts|safe }}</div>
        <h4>Gender Distribution</h4>
        <img src="data:image/png;base64,{{ preauth_gender_b64 }}" alt=""/>
        <div class="callouts">{{ preauth_gender_callouts|safe }}</div>
        {% if map_preauth_b64 %}
          <img src="data:image/png;base64,{{ map_perauth_b64 }}" alt="Map View">
        {% endif %}
      </section>
    {% endif %}
  </main>
</body></html>
