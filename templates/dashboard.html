{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard – PMJAY Fraud Detection{% endblock %}

{% block content %}
    <div class="generated-on">
        <h5>
        Generated on: 
        <span id="generatedOn">
            <span class="gen-date"></span><span class="gen-separator">, </span><span class="gen-time"></span>
        </span>
        </h5>
    </div>

    <div id="date-filters" class="date-filters">
        <div class="date-container">
            <label>From:</label>
            <select id="from-month"></select>
            <select id="from-day"></select>
            <select id="from-year"></select>
        </div>
        <div class="date-container">
            <label>To:</label>
            <select id="to-month"></select>
            <select id="to-day"></select>
            <select id="to-year"></select>
        </div>
        <button id="apply-date-filter" class="btn-run">Run</button>
    </div>

    <div class="dashboard-cards">
        <!-- Column 1 -->
        <div class="card-column main-column">
            <!-- Flagged Claims Card -->
            <div class="card flagged-claims" 
            data-modal-title="Flagged Claims Details">
                <button id="download-flagged" class="download-btn"  data-download-url="{% url 'download_flagged_claims' %}" data-district="{{ district_param|urlencode }}">
                    <i class="fas fa-download"></i>
                    <span class="btn-text"></span>
                </button>
                <div class="card-main">
                    <h2>Patient Admitted in Watchlist Hospitals</h2>
                    <span class="card-value">0</span>
                    {% comment %} <div class="card-trend up">↑ 12% from last month</div> {% endcomment %}
                </div>
                <div class="card-hover-content">
                    <div class="time-metric">
                        <span class="time-label">Overall:</span>
                        <span class="time-value">0</span>
                    </div>
                    <div class="time-metric">
                        <span class="time-label">Yesterday:</span>
                        <span class="time-value">0</span>
                    </div>
                    <div class="time-metric">
                        <span class="time-label">Last 30 days:</span>
                        <span class="time-value">0</span>
                    </div>
                </div>
            </div>
            
            <!-- High Value Claims Card -->
            <div class="card high-value" 
            data-download-url="{% url 'download_high_value_claims' %}"
            data-district="{{ district_param|urlencode }}">
                <button class="download-btn">
                    <i class="fas fa-download"></i>
                    <span class="btn-text"></span>
                </button>
                <div class="card-main">
                    <h2>High Value Claims</h2>
                    <span class="card-value">0</span>
                    {% comment %} <div class="card-trend down">↓ 5% from last month</div> {% endcomment %}
                </div>
                <div class="card-hover-content split-view">
                    <!-- Surgical Section -->
                    <div class="category-box surgical">
                        <div class="category-header surgical-header">
                            <h4>Surgical</h4>
                        </div>
                        <div class="time-metric">
                            <span class="time-label">Overall:</span>
                            <span class="time-value">0</span>
                        </div>
                        <div class="time-metric">
                            <span class="time-label">Yesterday:</span>
                            <span class="time-value">0</span>
                        </div>
                        <div class="time-metric">
                            <span class="time-label">Last 30 days:</span>
                            <span class="time-value">0</span>
                        </div>
                    </div>
                    
                    <!-- Divider Line -->
                    <div class="vertical-divider"></div>
                    
                    <!-- Medical Section -->
                    <div class="category-box medical">
                        <div class="category-header medical-header">
                            <h4>Medical</h4>
                        </div>
                        <div class="time-metric">
                            <span class="time-label">Overall:</span>
                            <span class="time-value">0</span>
                        </div>
                        <div class="time-metric">
                            <span class="time-label">Yesterday:</span>
                            <span class="time-value">0</span>
                        </div>
                        <div class="time-metric">
                            <span class="time-label">Last 30 days:</span>
                            <span class="time-value">0</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Hospital Bed Cases Card -->
            <div class="card hospital-beds" 
            data-details-url="{% url 'get_hospital_bed_details' %}"
            data-download-url="{% url 'download_hospital_bed_cases_excel' %}"
            data-district="{{ district_param|urlencode }}">
                <button class="download-btn">
                    <i class="fas fa-download"></i>
                    <span class="btn-text"></span>
                </button>
                <div class="card-main">
                    <h2>Hospital Bed Cases</h2>
                    <span class="card-value">0</span>
                    {% comment %} <div class="card-trend up">↑ 8% from last month</div> {% endcomment %}
                </div>
                <div class="card-hover-content">
                    <div class="time-metric">
                        <span class="time-label">Overall:</span>
                        <span class="time-value">0</span>
                    </div>
                    <div class="time-metric">
                        <span class="time-label">Yesterday:</span>
                        <span class="time-value">0</span>
                    </div>
                    <div class="time-metric">
                        <span class="time-label">Last 30 days:</span>
                        <span class="time-value">0</span>
                    </div>
                    <div class="violations-container" style="display:none;"></div>
                </div>
            </div>
            
            <!-- Family ID Cases Card -->
            <div class="card family-id" 
            data-details-url="{% url 'get_family_id_cases_details' %}"
            data-download-url="{% url 'download_family_id_cases_excel' %}"
            data-district="{{ district_param|urlencode }}">
                <button class="download-btn">
                    <i class="fas fa-download"></i>
                    <span class="btn-text"></span>
                </button>
                <div class="card-main">
                    <h2>Family ID Cases</h2>
                    <span class="card-value">0</span>
                    {% comment %} <div class="card-trend neutral">→ No change</div> {% endcomment %}
                </div>
                <div class="card-hover-content">
                    <div class="time-metric">
                        <span class="time-label">Overall:</span>
                        <span class="time-value">0</span>
                    </div>
                    <div class="time-metric">
                        <span class="time-label">Yesterday:</span>
                        <span class="time-value">0</span>
                    </div>
                    <div class="time-metric">
                        <span class="time-label">Last 30 days:</span>
                        <span class="time-value">0</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Column 2 -->
        <div class="card-column secondary-column">
            <!-- Geographic Anomalies Card -->
            <div class="card geo-anomalies" 
            data-details-url="{% url 'get_geo_anomalies_details' %}"
            data-download-url="{% url 'geographic_anomalies_excel' %}"
            data-district="{{ district_param|urlencode }}">
                <button class="download-btn">
                    <i class="fas fa-download"></i>
                    <span class="btn-text"></span>
                </button>
                <div class="card-main">
                    <h2>Geographic Anomalies</h2>
                    <span class="card-value">0</span>
                    {% comment %} <div class="card-trend up">↑ 15% from last month</div> {% endcomment %}
                </div>
                <div class="card-hover-content">
                    <div class="time-metric">
                        <span class="time-label">Overall:</span>
                        <span class="time-value">0</span>
                    </div>
                    <div class="time-metric">
                        <span class="time-label">Yesterday:</span>
                        <span class="time-value">0</span>
                    </div>
                    <div class="time-metric">
                        <span class="time-label">Last 30 days:</span>
                        <span class="time-value">0</span>
                    </div>
                </div>
            </div>
            
            <div class="card ophthalmology" 
            data-download-url="{% url 'download_ophthalmology_excel' %}"
            data-district="{{ district_param|urlencode }}">
                <button class="download-btn">
                    <i class="fas fa-download"></i>
                    <span class="btn-text"></span>
                </button>
                <div class="card-main">
                    <h2>Ophthalmology (Cataract)</h2>
                    <span class="card-value">0</span>
                    
                    <!-- Sub-cards Container -->
                    <div class="sub-cards">
                        <!-- Age < 40 Sub-card -->
                        <div class="sub-card age">
                            <div class="sub-card-header">
                                <h3>Age < 40</h3>
                                <div class="card-value">0</div>
                            </div>
                            {% comment %} <div class="card-trend up">↑ 22%</div> {% endcomment %}
                            <div class="sub-card-hover">
                                <div class="time-metric">
                                    <span class="time-label">Overall:</span>
                                    <span class="time-value">0</span>
                                </div>
                                <div class="time-metric">
                                    <span class="time-label">Yesterday:</span>
                                    <span class="time-value">0</span>
                                </div>
                                <div class="time-metric">
                                    <span class="time-label">Last 30 days:</span>
                                    <span class="time-value">0</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- OT Cases Sub-card -->
                        <div class="sub-card ot-cases">
                            <div class="sub-card-header">
                                <h3>OT Cases</h3>
                                <div class="card-value">0</div>
                            </div>
                            {% comment %} <div class="card-trend down">↓ 3%</div> {% endcomment %}
                            <div class="sub-card-hover">
                                <div class="time-metric">
                                    <span class="time-label">Overall:</span>
                                    <span class="time-value">0</span>
                                </div>
                                <div class="time-metric">
                                    <span class="time-label">Yesterday:</span>
                                    <span class="time-value">0</span>
                                </div>
                                <div class="time-metric">
                                    <span class="time-label">Last 30 days:</span>
                                    <span class="time-value">0</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Preauth Time Sub-card -->
                        <div class="sub-card preauth">
                            <div class="sub-card-header">
                                <h3>Preauth Time</h3>
                                <div class="card-value">0</div>
                            </div>
                            {% comment %} <div class="card-trend neutral">→ 0%</div> {% endcomment %}
                            <div class="sub-card-hover">
                                <div class="time-metric">
                                    <span class="time-label">Overall Avg:</span>
                                    <span class="time-value">0</span>
                                </div>
                                <div class="time-metric">
                                    <span class="time-label">Yesterday:</span>
                                    <span class="time-value">0</span>
                                </div>
                                <div class="time-metric">
                                    <span class="time-label">Last 30 days:</span>
                                    <span class="time-value">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- modal markup, if you want it only on this page -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal-container" 
        data-excel-url=""
        data-pdf-url="{% url 'download_flagged_claims_report' %}"
        data-details-url=""
        data-district="{{ district_param|urlencode }}">
            <!-- Loader -->
            <div id="pdfLoader" class="pdf-loading-overlay">
                <div class="pdf-loading-content">
                <h3>Generating PDF Report</h3>
                <div class="progress-container">
                    <div id="pdfProgressBar" class="progress-bar"></div>
                    <div id="pdfProgressText" class="progress-text">0%</div>
                </div>
                </div>
            </div>

            <!-- Fixed position buttons -->
            <button class="modal-pdf-download" type="button">
                <i class="fas fa-file-pdf"></i> Download PDF Report
            </button>
            <button class="modal-close">
                <span class="close-icon">✕</span>
            </button>
            
            <!-- Header (fixed when scrolling) -->
            <div class="modal-header">
                <h3 id="modalTitle"></h3>
            </div>
            
            <!-- Scrollable content area -->
            <div class="modal-content" id="modalContent">
                <!-- Table container -->
                <div class="data-table-container">
                    <button class="table-download-btn">
                        <i class="fas fa-download"></i> Export Excel
                    </button>
                    <div class="table-footer">
                        Showing <span id="rowCount">0</span> records
                    </div>
                </div>
                
                <!-- Bar Chart Container -->
                <div class="chart-container">
                    <h4>District-wise Flagged Claims Distribution</h4>
                    <canvas id="flaggedClaimsChart"></canvas>
                    <div class="chart-legend" id="flaggedClaimsLegend"></div>
                </div>
                
                <!-- Dual Pie Charts Container -->
                <div class="dual-pie-container">
                    <!-- Age Distribution Pie -->
                    <div class="pie-card">
                        <h4>Age Group Distribution</h4>
                        <div class="chart-wrapper">
                            <canvas id="agePieChart"></canvas>
                            <div class="chart-callouts" id="ageCallouts"></div>
                        </div>
                    </div>
                    
                    <!-- Gender Distribution Pie -->
                    <div class="pie-card">
                        <h4>Gender Distribution</h4>
                        <div class="chart-wrapper">
                            <canvas id="genderPieChart"></canvas>
                            <div class="chart-callouts" id="genderCallouts"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
  <!-- first include global PDF_URLS script if needed -->
  <script>
    window.PDF_URLS = {
        flagged:   "{% url 'download_flagged_claims_report' %}",
        highValue: "{% url 'download_high_value_claims_report' %}",
        hospitalBeds:  "{% url 'download_hospital_bed_report' %}",
        familyId:      "{% url 'download_family_id_cases_report' %}",
        geoAnomalies:  "{% url 'download_geo_anomalies_pdf_report' %}",
        ophthalmology: "{% url 'download_ophthalmology_pdf_report' %}"
      };
  </script>
  <script src="{% static 'js/dashboard.js' %}"></script>
{% endblock %}
